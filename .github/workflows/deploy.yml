name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH key
        run: |
          echo -e "${{ secrets.PIXINVENT_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy code to server
        run: |
          rsync -avz --delete -e "ssh -i key.pem -o StrictHostKeyChecking=no" ./ root@188.120.238.80:/var/www/html

      - name: Execute remote commands
        run: |
          ssh -i key.pem -o StrictHostKeyChecking=no root@188.120.238.80 << 'EOF'
            echo "Current user: $(whoami)"
            echo "Current directory: $(pwd)"
            cd /var/www/html || exit 1
            git config --global --add safe.directory /var/www/html
            git pull
            chown -R www-data:www-data storage         
            if [ ! -f .env ]; then
              cp .env.example .env
            fi
            export COMPOSER_ALLOW_SUPERUSER=1
            composer update
            mysql -u root -p'root' -e "CREATE DATABASE IF NOT EXISTS laravel;"
            php artisan migrate:fresh --seed
            export NODE_OPTIONS=--max-old-space-size=4096
            bun install --legacy-peer-deps
            bun run build
          EOF
